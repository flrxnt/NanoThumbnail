<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NanoThumbnail - SaaS Generator</title>
    <link rel="icon" href="data:,">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Icons (FontAwesome CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- RESET & VARIABLES --- */
        :root {
            --bg-dark: #0a0a0f;
            --bg-panel: #13131f;
            --primary: #6d28d9; /* Violet */
            --primary-hover: #7c3aed;
            --accent: #d8b4fe;
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.08);
            --glass: rgba(20, 20, 30, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --radius: 12px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --font-family: 'Plus Jakarta Sans', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(109, 40, 217, 0.15) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(59, 130, 246, 0.1) 0%, transparent 25%);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .btn {
            cursor: pointer;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #4f46e5);
            color: white;
            box-shadow: 0 4px 15px rgba(109, 40, 217, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(109, 40, 217, 0.6);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
        }

        /* --- LAYOUT --- */
        header {
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            background: rgba(10, 10, 15, 0.8);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo span { color: var(--accent); }

        /* --- LANDING PAGE --- */
        #landing-view {
            flex: 1;
            display: block; /* Changed for scrollable content */
            overflow-y: auto;
            position: relative;
        }
        .hero-section {
            min-height: 85vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
        }
        .hero-title {
            font-size: 3.5rem;
            line-height: 1.1;
            margin-bottom: 1.5rem;
            background: linear-gradient(to right, #fff, #d8b4fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .hero-subtitle {
            font-size: 1.2rem;
            color: var(--text-muted);
            max-width: 600px;
            margin-bottom: 2.5rem;
        }
        
        .features-section {
            padding: 4rem 2rem 6rem 2rem;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid var(--border);
        }
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            max-width: 1100px;
            margin: 0 auto;
        }
        .feature-card {
            padding: 2rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: left;
            transition: transform 0.2s;
        }
        .feature-card:hover {
            transform: translateY(-5px);
        }
        .feature-icon {
            font-size: 2rem;
            margin-bottom: 1.5rem;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal-content {
            width: 100%;
            max-width: 450px;
            padding: 2rem;
            box-shadow: var(--shadow);
        }
        .input-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        .input-field {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 1rem;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* --- APP VIEW --- */
        #app-view {
            display: flex;
            flex: 1;
            overflow: hidden; /* Prevent body scroll */
            height: calc(100vh - 73px); /* header height approx */
        }

        /* Sidebar */
        .sidebar {
            width: 380px;
            border-right: 1px solid var(--border);
            padding: 1.5rem;
            overflow-y: auto;
            background: rgba(19, 19, 31, 0.5);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .sidebar-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-weight: 700;
        }

        /* Main Content */
        .main-area {
            flex: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            position: relative;
        }
        
        /* Image Upload */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            background: rgba(255,255,255,0.02);
        }
        .drop-zone:hover {
            border-color: var(--primary);
            background: rgba(109, 40, 217, 0.05);
        }
        .preview-img-container {
            position: relative;
            margin-top: 1rem;
            border-radius: 8px;
            overflow: hidden;
            display: none;
        }
        .preview-img {
            width: 100%;
            height: auto;
            display: block;
        }
        .remove-img {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        /* Selects */
        .select-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        select.input-field {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }

        /* Result Area */
        .result-container {
            width: 100%;
            max-width: 1024px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .result-placeholder {
            color: var(--text-muted);
            font-size: 1.2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .generated-image {
            max-width: 100%;
            max-height: 70vh;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--glass-border);
            min-height: 300px; /* Ensure layout stability */
            background: #000; /* Placeholder background */
        }

        /* History Panel */
        .history-panel {
            position: fixed;
            right: 0;
            top: 73px;
            bottom: 0;
            width: 320px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 50;
            padding: 1.5rem;
            overflow-y: auto;
        }
        .history-panel.open {
            transform: translateX(0);
        }
        .history-item {
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
        }
        .history-img {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: #000;
            aspect-ratio: 16/9;
            object-fit: cover;
        }
        .history-prompt {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Loader */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: var(--primary);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 900px) {
            #app-view { flex-direction: column; height: auto; overflow: visible; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--border); }
            .main-area { min-height: 500px; }
            .hero-title { font-size: 2.5rem; }
        }

        /* --- MARKETING SECTIONS --- */
        .marketing-section {
            padding: 5rem 2rem;
            border-top: 1px solid var(--border);
        }
        .marketing-section.alt {
            background: rgba(255,255,255,0.02);
        }
        .section-header {
            text-align: center;
            max-width: 800px;
            margin: 0 auto 4rem auto;
        }
        .section-header h2 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(to right, #fff, var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .section-header p {
            color: var(--text-muted);
            font-size: 1.1rem;
            line-height: 1.6;
        }

        /* Steps */
        .steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 3rem;
            max-width: 1100px;
            margin: 0 auto;
            counter-reset: step;
        }
        .step-card {
            position: relative;
            padding: 2rem;
            text-align: center;
        }
        .step-number {
            font-size: 4rem;
            font-weight: 800;
            color: rgba(255,255,255,0.05);
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 0;
        }
        .step-content {
            position: relative;
            z-index: 1;
        }

        /* Problem/Solution */
        .split-layout {
            display: flex;
            align-items: center;
            gap: 4rem;
            max-width: 1100px;
            margin: 0 auto;
        }
        .split-content { flex: 1; text-align: left; }
        .split-visual { 
            flex: 1; 
            background: linear-gradient(135deg, rgba(19, 19, 31, 0.8), rgba(109, 40, 217, 0.1));
            border: 1px solid var(--border);
            border-radius: 20px;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        /* Chart Animation */
        .chart-container {
            width: 80%;
            height: 60%;
            position: relative;
            border-left: 1px solid rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .chart-line {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            stroke: #f87171; /* Softer red */
            stroke-width: 2;
            fill: none;
            stroke-dasharray: 300;
            stroke-dashoffset: 300;
            animation: drawChart 5s ease-in-out infinite;
            opacity: 0.8;
        }
        @keyframes drawChart {
            0% { stroke-dashoffset: 300; opacity: 0; }
            15% { opacity: 1; }
            85% { stroke-dashoffset: 0; opacity: 1; }
            100% { stroke-dashoffset: 0; opacity: 0; }
        }
        .chart-dot {
            display: none;
        }
        
        /* FAQ */
        .faq-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            max-width: 1000px;
            margin: 0 auto;
        }
        .faq-item h3 { margin-bottom: 0.5rem; color: var(--text-main); }
        .faq-item p { color: var(--text-muted); font-size: 0.95rem; line-height: 1.5; }

        @media (max-width: 768px) {
            .split-layout { flex-direction: column; }
            .faq-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="logo" onclick="showLanding()">
            <i class="fa-solid fa-bolt" style="color: var(--primary);"></i>
            Nano<span>Thumbnail</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button id="historyBtn" class="btn btn-secondary hidden" onclick="toggleHistory()">
                <i class="fa-solid fa-clock-rotate-left"></i>
            </button>
            <button class="btn btn-secondary" onclick="openSettings()">
                <i class="fa-solid fa-gear"></i> API
            </button>
        </div>
    </header>

    <!-- View: Landing -->
    <div id="landing-view">
        
        <!-- Hero -->
        <div class="hero-section">
            <h1 class="hero-title">Générez des miniatures<br>virales avec l'IA</h1>
            <p class="hero-subtitle">Utilisez la puissance de <strong>Google Nano Banana Pro</strong> pour transformer vos idées en miniatures YouTube percutantes.</p>
            <button class="btn btn-primary" onclick="startApp()" style="padding: 16px 32px; font-size: 1.1rem;">
                Commencer maintenant <i class="fa-solid fa-arrow-right"></i>
            </button>
            <p style="margin-top: 1.5rem; font-size: 0.9rem; color: var(--text-muted); opacity: 0.7;">
                <i class="fa-solid fa-check" style="color: var(--primary);"></i> Gratuit (Interface) &nbsp;&nbsp;
                <i class="fa-solid fa-check" style="color: var(--primary);"></i> BYOK (Replicate)
            </p>
        </div>

        <!-- Features -->
        <div class="features-section">
            <h2 style="text-align: center; margin-bottom: 3rem; font-size: 2rem;">Pourquoi choisir NanoThumbnail ?</h2>
            
            <div class="features-grid">
                <!-- Feature 1 -->
                <div class="glass-panel feature-card">
                    <div class="feature-icon" style="color: var(--primary);">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                    </div>
                    <h3 style="margin-bottom: 1rem;">Nano Banana Pro</h3>
                    <p style="color: var(--text-muted); line-height: 1.6;">
                        Nous utilisons le dernier modèle de Google, reconnu comme le <strong>meilleur générateur d'images</strong> du marché actuel. Il excelle particulièrement dans le rendu de texte et le réalisme photo.
                    </p>
                </div>

                <!-- Feature 2 -->
                <div class="glass-panel feature-card">
                    <div class="feature-icon" style="color: var(--accent);">
                        <i class="fa-solid fa-wallet"></i>
                    </div>
                    <h3 style="margin-bottom: 1rem;">100% Gratuit</h3>
                    <p style="color: var(--text-muted); line-height: 1.6;">
                        Notre outil est une interface gratuite et open-source. <strong>Aucun abonnement caché</strong>, aucune commission sur vos créations. Vous ne payez que ce que vous consommez.
                    </p>
                </div>

                <!-- Feature 3 -->
                <div class="glass-panel feature-card">
                    <div class="feature-icon" style="color: #34d399;">
                        <i class="fa-solid fa-key"></i>
                    </div>
                    <h3 style="margin-bottom: 1rem;">Bring Your Own Key</h3>
                    <p style="color: var(--text-muted); line-height: 1.6;">
                        Connectez directement votre compte <strong>Replicate</strong>. C'est la garantie de payer le prix réel fournisseur et de garder le contrôle total sur vos données et votre API.
                    </p>
                </div>
            </div>
        </div>

        <!-- Section: Problem / Solution -->
        <div class="marketing-section alt">
            <div class="split-layout">
                <div class="split-content">
                    <div class="sidebar-title" style="margin-bottom: 1rem;">Le Problème</div>
                    <h2 style="font-size: 2.5rem; margin-bottom: 1.5rem; line-height: 1.2;">Vos vidéos méritent mieux que 0 clic</h2>
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem; line-height: 1.6;">
                        Vous passez des heures sur le montage, mais tout se joue en 0.3 seconde. Si votre miniature n'accroche pas, personne ne regardera.
                    </p>
                    <p style="color: var(--text-muted); line-height: 1.6;">
                    
                        <strong>NanoThumbnail change la donne.</strong>
                    </p>
                </div>
                <div class="split-visual">
                    <!-- Animated Chart SVG -->
                    <div class="chart-container">
                        <svg width="100%" height="100%" viewBox="0 0 200 100" preserveAspectRatio="none">
                            <!-- A crashing curve -->
                            <path class="chart-line" d="M0,10 Q50,10 80,40 T150,80 T200,90" />
                        </svg>
                        <!-- Axis labels (optional visual flair) -->
                        <div style="position: absolute; bottom: -25px; left: 0; color: var(--text-muted); font-size: 0.7rem;">Jours</div>
                        <div style="position: absolute; left: -30px; top: 0; color: var(--text-muted); font-size: 0.7rem;">Vues</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section: How it works -->
        <div class="marketing-section">
            <div class="section-header">
                <h2>3 étapes vers la viralité</h2>
                <p>Plus simple, ça n'existe pas. Nous avons supprimé toute friction technique pour vous laisser créer.</p>
            </div>
            
            <div class="steps-grid">
                <div class="step-card">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3 style="margin-bottom: 1rem;">L'Idée</h3>
                        <p style="color: var(--text-muted);">Décrivez votre scène : "Un développeur choqué devant son écran". Pas besoin de prompt complexe.</p>
                    </div>
                </div>
                <div class="step-card">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h3 style="margin-bottom: 1rem;">L'IA</h3>
                        <p style="color: var(--text-muted);">Nano Banana Pro génère votre miniature en haute définition, en intégrant parfaitement le texte demandé.</p>
                    </div>
                </div>
                <div class="step-card">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h3 style="margin-bottom: 1rem;">Le Résultat</h3>
                        <p style="color: var(--text-muted);">Téléchargez votre miniature en PNG/JPG et uploadez-la directement sur YouTube.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section: FAQ -->
        <div class="marketing-section alt">
            <div class="section-header">
                <h2>Questions Fréquentes</h2>
            </div>
            <div class="faq-grid">
                <div class="glass-panel faq-item" style="padding: 1.5rem;">
                    <h3>Est-ce vraiment gratuit ?</h3>
                    <p>L'interface NanoThumbnail est 100% gratuite. Cependant, la génération d'images utilise l'API Replicate qui est payante (environ 0.14$ par image). Vous payez directement Replicate.</p>
                </div>
                <div class="glass-panel faq-item" style="padding: 1.5rem;">
                    <h3>Ma clé API est-elle sécurisée ?</h3>
                    <p>Oui. Votre clé est stockée uniquement dans votre navigateur (LocalStorage). Elle n'est jamais envoyée sur nos serveurs (nous n'en avons pas !).</p>
                </div>
                <div class="glass-panel faq-item" style="padding: 1.5rem;">
                    <h3>Puis-je utiliser les images commercialement ?</h3>
                    <p>Oui, les images générées par Nano Banana Pro via Replicate vous appartiennent généralement. Vérifiez les CGU de Replicate pour les détails.</p>
                </div>
                <div class="glass-panel faq-item" style="padding: 1.5rem;">
                    <h3>Pourquoi ce modèle est-il meilleur ?</h3>
                    <p>Google Nano Banana Pro a été spécifiquement entraîné pour comprendre des instructions complexes et gérer le texte, ce qui est le point faible de Midjourney ou DALL-E.</p>
                </div>
            </div>
        </div>

        <!-- Final CTA -->
        <div class="marketing-section" style="text-align: center;">
            <h2 style="font-size: 3rem; margin-bottom: 2rem;">Prêt à exploser votre CTR ?</h2>
            <button class="btn btn-primary" onclick="startApp()" style="padding: 20px 40px; font-size: 1.2rem;">
                Créer ma première miniature <i class="fa-solid fa-rocket" style="margin-left: 10px;"></i>
            </button>
        </div>

        <!-- Footer -->
        <footer style="text-align: center; padding: 2rem; color: var(--text-muted); font-size: 0.9rem; border-top: 1px solid var(--border);">
            <p>YoanDev - NanoThumbnail © 2025 • Propulsé par Replicate & Google Nano Banana Pro</p>
        </footer>

    </div>

    <!-- View: App -->
    <div id="app-view" class="hidden">
        
        <!-- Sidebar Controls -->
        <aside class="sidebar">
            
            <div class="section">
                <div class="sidebar-title">1. Votre Idée (Prompt)</div>
                <textarea id="promptInput" class="input-field" rows="4" placeholder="Décrivez votre miniature (ex: Visage choqué, fond explosion, texte 'INCROYABLE'...)"></textarea>
            </div>

            <div class="section">
                <div class="sidebar-title">2. Image de Référence (Optionnel)</div>
                <div class="drop-zone" id="dropZone">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-muted);"></i>
                    <p style="font-size: 0.8rem; color: var(--text-muted);">Cliquez ou glissez une image ici</p>
                    <input type="file" id="fileInput" accept="image/*" hidden>
                </div>
                <div id="previewContainer" class="preview-img-container">
                    <img id="previewImage" class="preview-img" src="" alt="Preview">
                    <button class="remove-img" onclick="clearImage()"><i class="fa-solid fa-times"></i></button>
                </div>
            </div>

            <div class="section">
                <div class="sidebar-title">3. Paramètres</div>
                
                <div class="select-row">
                    <div class="input-group">
                        <label>Résolution</label>
                        <select id="resolutionSelect" class="input-field">
                            <option value="1K">1K (Rapide)</option>
                            <option value="2K" selected>2K (Standard)</option>
                            <option value="4K">4K (Haut de gamme)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Format (Ratio)</label>
                        <select id="aspectRatioSelect" class="input-field">
                            <option value="16:9" selected>16:9 (Youtube)</option>
                            <option value="9:16">9:16 (Shorts)</option>
                            <option value="4:3">4:3</option>
                            <option value="1:1">1:1 (Carré)</option>
                            <option value="match_input_image">Match Input</option>
                        </select>
                    </div>
                </div>

                <div class="select-row">
                    <div class="input-group">
                        <label>Format Fichier</label>
                        <select id="formatSelect" class="input-field">
                            <option value="png">PNG</option>
                            <option value="jpg">JPG</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Sécurité</label>
                        <select id="safetySelect" class="input-field">
                            <option value="block_medium_and_above">Moyen</option>
                            <option value="block_only_high" selected>Permissif</option>
                            <option value="block_low_and_above">Strict</option>
                        </select>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" id="generateBtn" onclick="generateImage()">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Générer Miniature
            </button>

        </aside>

        <!-- Main Result Area -->
        <main class="main-area">
            <div class="result-container" id="resultContainer">
                <div class="result-placeholder" id="placeholder">
                    <i class="fa-solid fa-image" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p>Votre création apparaîtra ici</p>
                </div>
                
                <div id="loader" class="hidden" style="text-align:center;">
                    <span class="loader"></span>
                    <p style="margin-top: 1rem; color: var(--accent);">L'IA travaille...</p>
                    <p id="statusText" style="font-size:0.8rem; color: var(--text-muted); white-space: pre-wrap; line-height: 1.5;">Initialisation...</p>
                </div>

                <img id="finalImage" class="generated-image hidden" src="" alt="Result">
            </div>
            
            <div id="actionsBar" class="hidden" style="margin-top: 1rem; display: flex; gap: 10px;">
                <a id="downloadLink" href="#" download="miniature.png" class="btn btn-primary">
                    <i class="fa-solid fa-download"></i> Télécharger
                </a>
            </div>
        </main>

    </div>

    <!-- History Panel -->
    <div id="historyPanel" class="history-panel">
        <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem;">
            <h3 style="font-weight:700;">Historique</h3>
            <button onclick="toggleHistory()" style="background:none; border:none; color:white; cursor:pointer;"><i class="fa-solid fa-times"></i></button>
        </div>
        <div id="historyList">
            <!-- Items injected via JS -->
            <p style="color: var(--text-muted); font-size: 0.9rem;">Aucun historique récent.</p>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal-content glass-panel">
            <h2 style="margin-bottom: 1rem;">Configuration</h2>
            <div class="input-group">
                <label>Clé API Replicate</label>
                <input type="password" id="apiKeyInput" class="input-field" placeholder="r8_...">
                <small style="color: var(--text-muted); font-size: 0.8rem;">Stockée localement dans votre navigateur.</small>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="closeSettings()">Annuler</button>
                <button class="btn btn-primary" onclick="saveSettings()">Sauvegarder</button>
            </div>
        </div>
    </div>

    <script>
        /* --- STATE & CONFIG --- */
        const state = {
            apiKey: localStorage.getItem('nano_api_key') || '',
            proxyUrl: 'https://corsproxy.io/?', 
            history: JSON.parse(localStorage.getItem('nano_history') || '[]'),
            currentImageBase64: null
        };

        // DOM Elements
        const views = {
            landing: document.getElementById('landing-view'),
            app: document.getElementById('app-view'),
            modal: document.getElementById('settingsModal'),
            history: document.getElementById('historyPanel')
        };

        /* --- NAVIGATION --- */
        function showLanding() {
            views.landing.classList.remove('hidden');
            views.app.classList.add('hidden');
            // Hide history button and close history panel on landing
            document.getElementById('historyBtn').classList.add('hidden');
            views.history.classList.remove('open');
        }

        function startApp() {
            if (!state.apiKey) {
                openSettings();
            } else {
                views.landing.classList.add('hidden');
                views.app.classList.remove('hidden');
                // Show history button when in app view
                document.getElementById('historyBtn').classList.remove('hidden');
                renderHistory();
            }
        }

        function openSettings() {
            document.getElementById('apiKeyInput').value = state.apiKey;
            views.modal.classList.remove('hidden');
        }

        function closeSettings() {
            views.modal.classList.add('hidden');
        }

        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            
            if (key) {
                state.apiKey = key;
                localStorage.setItem('nano_api_key', key);
                closeSettings();
                // If we were on landing, go to app
                if (!views.landing.classList.contains('hidden')) {
                    startApp();
                }
            } else {
                alert("Veuillez entrer une clé API valide.");
            }
        }

        function toggleHistory() {
            views.history.classList.toggle('open');
        }

        function loadHistoryImage(url, prompt) {
            // Switch to app view if on landing
            if (!views.app.classList.contains('hidden')) {
                // Already in app view
            } else {
                // Switch from landing to app
                views.landing.classList.add('hidden');
                views.app.classList.remove('hidden');
                document.getElementById('historyBtn').classList.remove('hidden');
            }
            // Close history panel
            views.history.classList.remove('open');
            // Load the image
            displayResult(url, prompt);
        }

        function loadHistoryImageByIndex(element) {
            try {
                const index = parseInt(element.getAttribute('data-index'));
                if (index >= 0 && index < state.history.length) {
                    const item = state.history[index];
                    loadHistoryImage(item.url, item.prompt);
                }
            } catch (e) {
                console.error('Error loading history image:', e);
            }
        }

        /* --- IMAGE UPLOAD LOGIC --- */
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--primary)';
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--border)';
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--border)';
            if (e.dataTransfer.files.length) {
                processFile(e.dataTransfer.files[0]);
            }
        });

        function handleFileSelect(e) {
            if (e.target.files.length) {
                processFile(e.target.files[0]);
            }
        }

        function processFile(file) {
            if (!file.type.startsWith('image/')) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                state.currentImageBase64 = e.target.result;
                document.getElementById('previewImage').src = state.currentImageBase64;
                document.getElementById('previewContainer').style.display = 'block';
                document.getElementById('dropZone').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            state.currentImageBase64 = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('dropZone').style.display = 'block';
        }

        /* --- API LOGIC (REPLICATE - NANO BANANA PRO) --- */
        async function generateImage() {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) return alert("Veuillez décrire votre miniature.");
            
            // UI Updates
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('placeholder').classList.add('hidden');
            document.getElementById('finalImage').classList.add('hidden');
            document.getElementById('actionsBar').classList.add('hidden');
            document.getElementById('loader').classList.remove('hidden');
            
            // Get specific Nano Banana Pro parameters
            const resolution = document.getElementById('resolutionSelect').value; // 1K, 2K, 4K
            const aspectRatio = document.getElementById('aspectRatioSelect').value; // 16:9, 4:3, etc.
            const format = document.getElementById('formatSelect').value;
            const safety = document.getElementById('safetySelect').value;

            // Build Input Object strictly according to Nano Banana Pro schema
            // Enrich prompt for YouTube Style
            const enhancedPrompt = `YouTube thumbnail, catchy, high contrast, vibrant colors, 4k, highly detailed, ${prompt}, cinematic lighting, expressive, viral style`;

            const inputData = {
                prompt: enhancedPrompt,
                resolution: resolution,
                aspect_ratio: aspectRatio,
                output_format: format,
                safety_filter_level: safety,
                image_input: [] // Default empty array
            };

            // Add image if exists (Must be an array of URIs according to schema)
            if (state.currentImageBase64) {
                inputData.image_input = [state.currentImageBase64];
            }

            try {
                // Using the specific model endpoint as requested
                const createUrl = `${state.proxyUrl}https://api.replicate.com/v1/models/google/nano-banana-pro/predictions`;
                
                const response = await fetch(createUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${state.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        input: inputData
                    })
                });

                if (!response.ok) {
                    const err = await response.text();
                    throw new Error(`Erreur API (${response.status}): ${err}`);
                }
                
                let prediction = await response.json();
                const predictionGetUrl = prediction.urls.get;
                const startTime = Date.now();

                // -----------------------------------------
                // POLLING LOOP (SUIVI DE LA CREATION)
                // -----------------------------------------
                while (prediction.status !== 'succeeded' && prediction.status !== 'failed' && prediction.status !== 'canceled') {
                    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                    document.getElementById('statusText').innerText = `Génération en cours... (${elapsed}s)\nStatut: ${prediction.status}`;
                    
                    // Wait 1s before next poll
                    await new Promise(r => setTimeout(r, 1000));
                    
                    // ANTI-CACHE: Add timestamp to force proxy to fetch fresh data
                    // Fix: Check if the TARGET URL has query params, not the proxy URL
                    const separator = predictionGetUrl.includes('?') ? '&' : '?';
                    const urlWithCacheBuster = `${predictionGetUrl}${separator}t=${Date.now()}`;
                    const finalUrl = `${state.proxyUrl}${encodeURIComponent(urlWithCacheBuster)}`;
                    
                    const pollResponse = await fetch(finalUrl, {
                        headers: { 'Authorization': `Token ${state.apiKey}` }
                    });
                    
                    if (pollResponse.ok) {
                        prediction = await pollResponse.json();
                        if (prediction.logs) console.log(prediction.logs); 
                    }
                }

                if (prediction.status !== 'succeeded') throw new Error(`La génération a terminé avec le statut: ${prediction.status}`);

                // Success
                document.getElementById('statusText').innerText = "Téléchargement de l'image...";
                // Fix: Check if output is an array before accessing index 0, otherwise use it directly as string
                const imageUrl = Array.isArray(prediction.output) ? prediction.output[0] : prediction.output;
                console.log('Image URL:', imageUrl);
                
                await displayResult(imageUrl, prompt);
                addToHistory(prompt, imageUrl);

            } catch (error) {
                console.error(error);
                alert("Erreur: " + error.message + "\n Vérifiez votre clé API ou le Proxy.");
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('placeholder').classList.remove('hidden');
            } finally {
                document.getElementById('generateBtn').disabled = false;
            }
        }

        async function displayResult(url, prompt) {
            const img = document.getElementById('finalImage');
            // Reset display
            img.classList.add('hidden');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('placeholder').classList.add('hidden'); // Hide placeholder when loading result
            
            // Update status text for history loading
            document.getElementById('statusText').innerText = "Chargement de l'image...";
            
            try {
                // Try to fetch via proxy to bypass CORS and for Blob creation
                // Check if URL is already a data URL or similar, if so use directly
                let finalSrc = url;
                let blobUrl = url;

                if (url.startsWith('http')) {
                    // IMPORTANT: Encode the target URL so the proxy handles it correctly
                    const proxyUrl = `${state.proxyUrl}${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error('Failed to fetch image via proxy');
                    const blob = await response.blob();
                    blobUrl = URL.createObjectURL(blob);
                    finalSrc = blobUrl;
                }

                img.src = finalSrc;
                
                img.onload = () => {
                    document.getElementById('loader').classList.add('hidden');
                    img.classList.remove('hidden');
                    
                    // Setup download with Blob URL (forces download)
                    const dlLink = document.getElementById('downloadLink');
                    dlLink.href = blobUrl;
                    dlLink.download = `nano-thumbnail-${Date.now()}.png`; // Ensure good filename
                    
                    document.getElementById('actionsBar').classList.remove('hidden');
                    document.getElementById('actionsBar').style.display = 'flex'; 
                };

                img.onerror = () => {
                    throw new Error("Image load failed");
                };

            } catch (e) {
                console.error("Image display error:", e);
                document.getElementById('loader').classList.add('hidden');
                
                // Fallback: Try to show it directly even if it fails (maybe user can open in new tab)
                img.src = url;
                img.classList.remove('hidden');

                alert("L'image a été générée mais l'affichage direct a rencontré un problème. Essayez le bouton de téléchargement.");
                
                const dlLink = document.getElementById('downloadLink');
                dlLink.href = url;
                document.getElementById('actionsBar').classList.remove('hidden');
                document.getElementById('actionsBar').style.display = 'flex'; 
            }
        }

        /* --- HISTORY LOGIC --- */
        function addToHistory(prompt, url) {
            const newItem = { prompt, url, date: new Date().toLocaleTimeString() };
            state.history.unshift(newItem);
            if (state.history.length > 10) state.history.pop();
            localStorage.setItem('nano_history', JSON.stringify(state.history));
            renderHistory();
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            if (state.history.length === 0) {
                list.innerHTML = '<p style="color: var(--text-muted);">Aucun historique récent.</p>';
                return;
            }
            
            list.innerHTML = state.history.map((item, index) => {
                const safePrompt = escapeHtml(item.prompt);
                return `
                <div class="history-item">
                    <img src="${item.url}" class="history-img" loading="lazy" data-index="${index}" onclick="loadHistoryImageByIndex(this)" style="cursor:pointer">
                    <p class="history-prompt">${safePrompt}</p>
                    <small style="color:var(--text-muted)">${item.date}</small>
                </div>
            `;
            }).join('');
        }

        // Init - Render history on page load
        renderHistory();
    </script>
</body>
</html>